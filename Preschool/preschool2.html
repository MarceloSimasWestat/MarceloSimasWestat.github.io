<!DOCTYPE html>
<!--
    Hyperspace by Pixelarity
    pixelarity.com @pixelarity
    License: pixelarity.com/license
-->
<html lang="en-us">
<head>
    <title>Preschool Education</title>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
    <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->

    <!--<link rel="stylesheet" href="widgets.css" />-->
    <!-- <link rel="stylesheet" href="assets/css/chart-styles.css" /> -->

    <!-- browser tab icon (aka favicon) -->
    <link rel="icon" href="images/doelogo_rev.png" />

    <!-- Scripts -->
    <!--<script src="widgets.js"></script>-->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="assets/js/main.js"></script>

    <!-- Substitutes high-res images for Retina displays (html file only) -->
    <script type="text/javascript" src="assets/js/retina.js"></script>

    <script src="assets/js/d3.v3.min.js"></script>
    <script src="assets/js/d3-tip.js"></script>
    <script src="assets/js/chart-functions.js"></script>
    <script src="assets/js/graph-scroll.js"></script>
    <script src="assets/js/queue.v1.min.js"></script>
    <script src="assets/js/topojson.v1.min.js"></script>

</head>
<body>

<div id="loader-wrapper">
    <div id="loader"></div>
    <div class="loader-section"></div>
</div>

<!-- Sidebar -->
<section id="sidebar">
    <div class="inner">

        <div class="nav-image">
            <img src="images/edsealbw.svg" alt="U.S. Department of Education" />
        </div>

        <div class="nav-wrapper">
            <nav>
                <ul style="margin-bottom: 1.5em;">
                    <li><a href="#intro">Introduction</a></li>
                    <li><a href="#one">District Preschool Participation Mapped</a></li>
                    <li><a href="#two">Uneven Impact</a></li>
                    <li><a href="#three">The Preschool Crisis</a></li>
                    <li><a href="#four">Wrap Up</a></li>
                </ul>
            </nav>
            <ul class="icons socialmedia" style="margin-bottom: 0;">
                <li><a href="https://twitter.com/home?status=DYK?%20%2B2.5M%20students%20were%20out-of-school%20suspended%20in%202013-14.%20Among%20those,%0A25%25%20were%20black%20males.%20http%3A//www2.ed.gov/datastory/discipline/index.html" target="_blank" title="Tweet" class="fa-twitter"><span class="label">Twitter</span></a></li>
                <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A//www2.ed.gov/datastory/discipline/index.html" target="_blank" title="Share on Facebook" class="fa-facebook"><span class="label">Facebook</span></a></li>
                <li><a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A//www2.ed.gov/datastory/discipline/index.html&title=Rethink%20Discipline.%20Who%20is%20losing%20critical%20learning%20time%20because%20of%20out-of-school%20suspension?&summary=&source=" target="_blank" title="Share on LinkedIn" class="fa-linkedin"><span class="label">LinkedIn</span></a></li>
                <li><a href="mailto:?&subject=Rethink Discipline: The Impact of Out of School Suspensions&body=%20http%3A%2F%2Fwww2.ed.gov%2Fdatastory%2Fdiscipline%2Findex.html" target="_blank" title="Email" class="fa-envelope"><span class="label">Email</span></a></li>
            </ul>
        </div>

        <!-- Given Flex, this allows the social media icons to be paired with the navigation links without hugging the bottom -->
        <div>
            &nbsp;
        </div>
    </div>
</section>

<!-- Wrapper -->
<div id="wrapper">

    <!-- Suspension Map -->
    <section class="wrapper chart">
        <div class="inner">

            <div>
                <div class="align-center">
                    <div id="mapWrapper">

                        <div id="legend">
                            <h3>Percentage of Early Elementary Population Enrolled in Public Preschool Programs</h3>
                            <div class="legendButtonWrapper">
                                <div data-value="#dadaeb" class="legendButton">
                                    <hr class="verticalLine" size="25">
                                    <div class="legendText">&nbsp;</div>
                                </div><div data-value="#bcbddc" class="legendButton">
                                <hr class="verticalLine" size="25">
                                <div class="legendText">0%</div>
                            </div><div data-value="#9e9ac8" class="legendButton">
                                <hr class="verticalLine" size="25">
                                <div class="legendText">15%</div>
                            </div><div data-value="#756bb1" class="legendButton">
                                <hr class="verticalLine" size="25">
                                <div class="legendText">30%</div>
                            </div><div data-value="#54278f" class="legendButton">
                                <hr class="verticalLine" size="25">
                                <div class="legendText">45%</div>
                            </div>
                            </div>
                            <div class="innerLegend">
                                <div data-value="gray" class="legendButton null">
                                <hr class="verticalLine" size="25">
                                <div class="legendText">NULL*</div>
                            </div>
                            </div>
                        </div>

                        <div id="map">
                            <div>
                                <button class="toggleButton rttGrantToggle" style="float:left">RTT-ELC Grant States</button>
                                <button class="toggleButton pdgGrantToggle" style="float:left">PDG Grant States</button>
                                <button class="toggleButton allStatesToggle" style="float:left; display: none">Show All States</button>
                                <div style="clear: both; height:5px"></div>
                                <button class="zoomButton" data-zoom="+1">+</button>
                                <div style="clear: both; height:5px"></div>
                                <button class="zoomButton" data-zoom="-1">-</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <br/>
                <p class="dataLinksText">* <a href="#datanotes">See data notes</a>. <a href="../Discipline/assets/data/CRDC2013_14disc_LEAmap_data.xlsx">Download the district level data</a> used in this map.</p>
            </div>
        </div>
    </section>
</div>

<!-- Map -->

<script>
    /*
     "a":"State"
     "b":"Name"
     "c":"Preschool Students"
     "d":"g01_g02"
     "e":"pct_psenr"
     "f":"cpct_psenr"
     */
    $("#legend").css("display", "none");
    //  D3 MAP
    var width = 960;
    var height = 600;
    var center = [width / 2, height / 2];
    var defaultFill = "#E6E6E6";

    var projection = d3.geo.albersUsa()
            .translate([width / 2, height / 2])
            .scale(1000);
    var zoom = d3.behavior.zoom()
            .scaleExtent([1, 32])
            .on("zoom", move);

    var path = d3.geo.path()
            .projection(projection);

    var svg = d3.select("#map").append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 " + width + " " + height)
            .classed("svg-content-responsive", true)
            .append("g");

    var g = svg.append("g");

    svg.append("svg:image")
            .attr("xlink:href", "images/progress-anim.gif")
            .attr("id", "progress-image")
            .attr("width", 30)
            .attr("height", 30)
            .attr("x", width / 2)
            .attr("y", height / 2)
            .style("opacity", 1);

    svg.call(zoom).call(zoom.event);

    var tooltip = d3.select("body").append("div")
            .attr("class", "districtTooltip")
            .style("opacity", 0);

    queue()
            .defer(d3.json, "assets/data/states.json")
            .defer(d3.json, "assets/data/elementaryunified.json")
            .defer(d3.json, "assets/data/extradistricts.json")
            .await(ready);

    svg.on("wheel.zoom", null);
    svg.on("mousewheel.zoom", null);

    function ready(error, us, primary, extra) {
        if (error) {
            console.log(error);
        }
        g.attr("cursor","pointer");

        g.append("g")
                .selectAll("path")
                .data(topojson.feature(primary, primary.objects.medium_G5420_G5400).features)
                .enter().append("path")
                .attr("id", "elementaryDistrict")
                .attr("class", "district")
                .attr("d", path)
                .attr("stroke", "#fff")
                .attr("stroke-opacity", .15)
                .attr("stroke-linejoin", "round")
                .on("mouseover", function (d) {
                    createTooltip(this,d);
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke", "#fff")
                            .attr("stroke-opacity", .15);
                    d3.select(this).classed("selected", false);
                    tooltip.transition().duration(300).style("opacity", 0);
                });

        g.append("g")
                .selectAll("path")
                .data(topojson.feature(extra, extra.objects.extra_districts).features)
                .enter().append("path")
                .attr("id", "elementaryDistrict")
                .attr("class", "district")
                .attr("d", path)
                .attr("stroke", "#fff")
                .attr("stroke-opacity", .15)
                .attr("stroke-linejoin", "round")
                .on("mouseover", function (d) {
                    createTooltip(this,d);
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke", "#fff")
                            .attr("stroke-opacity", .15);
                    d3.select(this).classed("selected", false);
                    tooltip.transition().duration(300).style("opacity", 0);
                });

        g.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("class", function(d){
                    var className = "state";
                    if (d.properties.ps_grant == 1) {
                        className = "state psState rttGrantState";
                        d3.select(this).attr("stroke", "white").style({"fill":"none","fill-opacity":0});
                    } else if (d.properties.ps_grant == 2) {
                        className = "state psState pdgGrantState";
                        d3.select(this).attr("stroke", "white").style({"fill":"none","fill-opacity":0});
                    } else if (d.properties.ps_grant == 3) {
                        className = "state psState bothGrantState";
                        d3.select(this).attr("stroke", "white").style({"fill":"none","fill-opacity":0});
                    }else {
                        d3.select(this).attr("stroke", "white").style({"fill":"none","fill-opacity":0});
                    }
                    return className;
                })
                .attr("d", path);

        updateColors();
        createLegend();
        svg.select("#progress-image").style("opacity", 0);
        $("#legend").css("display", "block");
    }

    function createTooltip(currentDistrict,d){
        var format = d3.format("0,000");
        //var decimal = d3.format(",.1f");
        var state = (d.properties.a === null)? "NO DATA": d.properties.a;
        var name = (d.properties.b === null)? "NO DATA": d.properties.b;
        if (d.properties.f === "0") {
            var preschoolStudents = (d.properties.c === null) ? "N/A" : "N/A";
            var g_g = (d.properties.d === null) ? "N/A" : "N/A";
            var pct_psenr = (d.properties.e === null) ? "N/A" : "N/A";
        } else {
            preschoolStudents = (d.properties.c === null) ? "NO DATA" : d.properties.c;
            g_g = (d.properties.d === null) ? "NO DATA" : d.properties.d;
            if (d.properties.e === null) {
                pct_psenr = "NO DATA";
            } else {
                pct_psenr = d.properties.e.replace(/%/g, "");
                if(pct_psenr > 100){
                    pct_psenr = ">100%";
                } else if (pct_psenr > 0 && pct_psenr < 1 ){
                    pct_psenr = "<0.5%";
                } else {
                    pct_psenr = pct_psenr + '%';
                }
            }
        }
        var cpct_psenr = (d.properties.f === null) ? "NO DATA" : d.properties.f;

        if(!isNaN(preschoolStudents)){
            preschoolStudents = format(preschoolStudents);
        }

        if(!isNaN(g_g)){
            g_g = format(g_g);
        }

        d3.select(currentDistrict).attr("stroke", "#1A1C20")
                .attr("stroke-opacity", 1);
        d3.select(currentDistrict).classed("selected", true);

        tooltip.transition().duration(100)
                .style("opacity", 1)
                .style("top", (d3.event.pageY - 100) + "px");

        var windowWidth = $(window).width();
        if (windowWidth > 1024) {
            if (d3.event.pageX > 1000) {
                tooltip.style("left", (d3.event.pageX - 320) + "px");
            } else {
                tooltip.style("left", (d3.event.pageX + 80) + "px");
            }
        }
        if (windowWidth < 1024 && windowWidth > 850) {
            if (d3.event.pageX > 400) {
                tooltip.style("left", (d3.event.pageX - 320) + "px");
            } else {
                tooltip.style("left", (d3.event.pageX + 80) + "px");
            }
        }
        if (windowWidth < 850) {
            if (d3.event.pageX > 350) {
                tooltip.style("left", (d3.event.pageX - 320) + "px");
            } else {
                tooltip.style("left", (d3.event.pageX + 40) + "px");
            }
        }
        if (windowWidth < 680) {
            if (d3.event.pageX > 350) {
                tooltip.style("left", (d3.event.pageX - 320) + "px");
            } else {
                tooltip.style("left", (d3.event.pageX + 20) + "px");
            }
        }
        if (name === "School District Not Defined") {
            tooltip.html("<h3>" + state.toUpperCase() + "</h3><hr>" +
                    "<h3>No Operating District</h3>");

        } else if (name != null ) {
            tooltip.html("<h3>" + state.toUpperCase() + "</h3><hr>" +
                    "<h4>" + name + "</h4><hr>" +
                    "<div> Preschool children enrolled: " + preschoolStudents + "</div>" +
                    "<div> Enrollment in grades 1 and 2: " + g_g + "</div>" +
                    "<div> Preschool as a % of grades 1 and 2 enrollment: " + pct_psenr + "</div>");
            if(d.properties.g == 1){
                tooltip.append("div").html("State preschool grant: RTT-ELC");
            } else if (d.properties.g == 2) {
                tooltip.append("div").html("State preschool grant: PDG");
            } else if (d.properties.g == 3){
                tooltip.append("div").html("State preschool grant: RTT-ELC and PDG");
            } else {
                tooltip.append("div").html("State preschool grant: None");
            }
        } else {
            tooltip.html("<h3>" + state.toUpperCase() + "</h3><hr>" +
                    "<h4>" + name + "</h4><hr>" +
                    "<div> NO DATA </div>");
        }
    }

    function createLegend() {
        var legendButton = $(".legendButton");
        legendButton.each(function () {
            var buttonValue = $(this).attr("data-value");
            var totalDistricts = document.getElementsByClassName("district").length;
            var valueSize = document.getElementsByClassName(buttonValue).length;
            var width = (valueSize / totalDistricts) * 100;
            //if ($(this).hasClass("missing")) {
            //    width = width * 100;
            //}
            if ($(this).hasClass("null")) {
                width = width * 4;
            }
            $(this).css("background-color", buttonValue);
            $(this).css("width", (width) + '%');
        });

        legendButton.on("click", function () {
            if ($(this).hasClass("highlightButton")) {
                legendButton.each(function () {
                    $(this).css("border", 0);
                    $(this).removeClass("highlightButton");
                });
                updateColors();
            } else {
                legendButton.each(function () {
                    $(this).css("border", 0);
                    $(this).removeClass("highlightButton");
                });
                $(this).addClass("highlightButton");
                var buttonValue = $(this).attr("data-value");
                svg.selectAll(".district")
                        .attr("fill", function (d) {
                            if (buttonValue == colorByGroup(d.properties.f)) {
                                return buttonValue;
                            } else {
                                return "#E6E6E6";
                            }
                        });
            }
        });

    }

    function updateColors() {
        svg.selectAll(".district")
                .attr("fill", function (d) {
                    d3.select(this).attr("class", "district " + colorByGroup(d.properties.f));
                    return colorByGroup(d.properties.f);
                });
    }

    function colorByGroup(f) {
        switch (f){
            case "1": return '#dadaeb'; break;
            case "2": return '#bcbddc'; break;
            case "3": return '#9e9ac8'; break;
            case "4": return '#756bb1'; break;
            case "5": return '#54278f'; break;
            default : return 'gray'; break;
        }
    }

    function interpolateZoom(translate, scale) {
        var self = this;
        return d3.transition().duration(350).tween("zoom", function () {
            var iTranslate = d3.interpolate(zoom.translate(), translate),
                    iScale = d3.interpolate(zoom.scale(), scale);
            return function (t) {
                zoom
                        .scale(iScale(t))
                        .translate(iTranslate(t));
                move();
            };
        });
    }

    function zoomClick() {
        var clicked = d3.event.target,
                direction = 1,
                factor = 0.2,
                target_zoom = 1,
                center = [width / 2, height / 2],
                extent = zoom.scaleExtent(),
                translate = zoom.translate(),
                translate0 = [],
                l = [],
                view = {x: translate[0], y: translate[1], k: zoom.scale()};
        d3.event.preventDefault();
        direction = this.getAttribute("data-zoom");
        target_zoom = zoom.scale() * (1 + factor * direction);

        if (target_zoom < extent[0] || target_zoom > extent[1]) {
            return false;
        }

        translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
        view.k = target_zoom;
        l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

        view.x += center[0] - l[0];
        view.y += center[1] - l[1];

        interpolateZoom([view.x, view.y], view.k);
    }

    function allStatesToggle(){
        d3.select(".allStatesToggle").style("display","none");
        d3.select(".rttGrantToggle").style({"background-color": "white", "color": "black"}).classed("active",false);
        d3.selectAll(".rttGrantState,.bothGrantState")
                .style({"stroke-opacity":1,"stroke":"white", "stroke-width": resizeStateBorder()});
        d3.select(".pdgGrantToggle").style({"background-color": "white", "color": "black"}).classed("active",false);
        d3.selectAll(".pdgGrantState,.bothGrantState")
                .style({"stroke-opacity":1,"stroke":"white", "stroke-width": resizeStateBorder()});
        d3.selectAll(".state").style({"fill":"none"});
    }

    function rttToggleGrantStates(){
        if(d3.select(".rttGrantToggle").classed("active")){
            d3.select(".allStatesToggle").style("display","none");
            d3.select(".rttGrantToggle").style({"background-color": "white", "color": "black"}).classed("active",false);
            d3.selectAll(".rttGrantState,.bothGrantState")
                    .style({"stroke-opacity":1,"stroke":"white", "stroke-width": resizeStateBorder()});
            d3.selectAll(".state").style({"fill":"none"});
        }else{
            d3.select(".allStatesToggle").style("display","block");
            if (d3.select(".pdgGrantToggle").classed("active")) {
                pdgToggleGrantStates();
                d3.select(".allStatesToggle").style("display","block");
            }
            d3.select(".rttGrantToggle").style({"background-color": "black", "color": "white"}).attr("class","rttGrantToggle active");
            d3.selectAll(".rttGrantState,.bothGrantState")
                    .style("stroke-width", resizeStateBorder()).style("stroke-opacity", function(){
                d3.select(this.parentNode.appendChild(this)).style("stroke","gray");
                return 1;
            });
            d3.selectAll(".state:not(.rttGrantState):not(.bothGrantState)").style({"fill-opacity": 0.7, "fill":"white"});
        }
    }

    function pdgToggleGrantStates(){
        if(d3.select(".pdgGrantToggle").classed("active")){
            d3.select(".allStatesToggle").style("display","none");
            d3.select(".pdgGrantToggle").style({"background-color": "white", "color": "black"}).classed("active",false);
            d3.selectAll(".pdgGrantState,.bothGrantState")
                    .style({"stroke-opacity":1,"stroke":"white", "stroke-width": resizeStateBorder()});
            d3.selectAll(".state").style({"fill":"none"});
        }else{
            d3.select(".allStatesToggle").style("display","block");
            if (d3.select(".rttGrantToggle").classed("active")) {
                rttToggleGrantStates();
                d3.select(".allStatesToggle").style("display","block");
            }
            d3.select(".pdgGrantToggle").style({"background-color": "black", "color": "white"}).attr("class","pdgGrantToggle active");
            d3.selectAll(".pdgGrantState,.bothGrantState")
                    .style("stroke-width", resizeStateBorder()).style("stroke-opacity", function(){
                d3.select(this.parentNode.appendChild(this)).style("stroke","gray");
                return 1;
            });
            d3.selectAll(".state:not(.pdgGrantState):not(.bothGrantState)").style({"fill-opacity": 0.7, "fill":"white"});
        }
    }

    function move() {
        d3.selectAll(".state").attr("stroke-width", resizeStateBorder());
        //d3.selectAll(".psState").style("stroke-width", resizePsStateBorder());
        g.style("stroke-width", 1 / zoom.scale())
                .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");
    }

    function resizePsStateBorder(){
        var z = zoom.scale();
        return (z > 7) ? .40 :
                (z > 4) ? .75 :
                        2
    }

    function resizeStateBorder() {
        var z = zoom.scale();
        return (z > 7) ? .25 :
                (z > 4) ? .5 :
                        1
    }

    d3.selectAll(".zoomButton[data-zoom]").on("click", zoomClick);
    d3.selectAll(".rttGrantToggle").on("click", rttToggleGrantStates);
    d3.selectAll(".pdgGrantToggle").on("click", pdgToggleGrantStates);
    d3.selectAll(".allStatesToggle").on("click", allStatesToggle);
    d3.select(self.frameElement).style("height", height + "px");

</script>
</body>
</html>
