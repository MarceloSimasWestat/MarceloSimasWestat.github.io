<!DOCTYPE html>
<!--
    Hyperspace by Pixelarity
    pixelarity.com @pixelarity
    License: pixelarity.com/license
-->
<html lang="en-us">
<head>
    <title>Out-of-School Suspensions</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!--[if lte IE 8]>
    <script src="assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="assets/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="assets/css/ie8.css"/><![endif]-->

    <!--<link rel="stylesheet" href="widgets.css" />-->
    <!-- <link rel="stylesheet" href="assets/css/chart-styles.css" /> -->

    <!-- browser tab icon (aka favicon) -->
    <link rel="icon" href="images/doelogo_rev.png"/>
    <!-- Scripts -->
    <!--<script src="widgets.js"></script>-->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <!--[if lte IE 8]>
    <script src="assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="assets/js/main.js"></script>

    <!-- Substitutes high-res images for Retina displays (html file only) -->
    <script type="text/javascript" src="assets/js/retina.js"></script>

    <script src="assets/js/d3.min.js"></script>
    <script src="assets/js/queue.v1.min.js"></script>
    <script src="assets/js/topojson.v1.min.js"></script>

</head>
<body>

<div id="loader-wrapper">
    <div id="loader"></div>
    <div class="loader-section"></div>
</div>

<!-- Sidebar -->
<section id="sidebar">
    <div class="inner">

        <div class="nav-image">
            <img src="images/edsealbw.svg" alt="Department of Learning"/>
        </div>

        <div class="nav-wrapper">
            <nav>
                <ul>
                    <li><a href="#three">Out of School Suspension</a></li>
                </ul>
            </nav>
            <ul class="icons socialmedia" style="margin-bottom: 0;">
                <li>
                    <a href="https://twitter.com/home?status=Over%206%20million%20students%20miss%2015%20days%20or%20more%20per%20school%20year.%20This%20needs%20to%20change.%20http%3A//bit.ly/ChronicAbsenteeismInAmerica%20%40usedgov"
                       target="_blank" title="Tweet" class="fa-twitter"><span class="label">Twitter</span></a></li>
                <li>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A//www2.ed.gov/datastory/chronicabsenteeism.html"
                       target="_blank" title="Share on Facebook" class="fa-facebook"><span class="label">Facebook</span></a>
                </li>
                <li>
                    <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fwww2.ed.gov%2Fdatastory%2Fchronicabsenteeism.html&title=Chronic%20Absenteeism%20in%20the%20Nation's%20Schools&summary=&source=http%3A%2F%2Fwww2.ed.gov%2Fdatastory%2Fchronicabsenteeism.html"
                       target="_blank" title="Share on LinkedIn" class="fa-linkedin"><span class="label">LinkedIn</span></a>
                </li>
                <li>
                    <a href="mailto:?subject=Chronic%20Absenteeism%20in%20the%20Nation's%20Schools&body=:%20http%3A%2F%2Fwww2.ed.gov%2Fdatastory%2Fchronicabsenteeism.html"
                       target="_blank" title="Email" class="fa-envelope"><span class="label">Email</span></a></li>
            </ul>
        </div>

        <!-- Given Flex, this allows the social media icons to be paired with the navigation links without hugging the bottom -->
        <div>
            &nbsp;
        </div>
    </div>
</section>

<!-- Wrapper -->
<div id="wrapper">


    <section id="three_chart" class="wrapper chart">
        <div class="inner">
            <div>
                <div class="align-center">
                    <div id="mapWrapper">
                        <div id="legend">
                            <h3><b>% of all students (preschool–12) who received one or more out-of-school
                                suspension</b></h3>
                        </div>
                        <div id="selectDistrictType">
                            <div id="selectElementary" class="selected ">Elementary and Unified</div>
                            <div id="selectSecondary" class="selected ">Independent Elementary, Secondary, and Unified
                            </div>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>


</div>


<!-- D3 charts -->
<script src="assets/js/d3.v3.min.js"></script>
<script src="assets/js/d3-tip.js"></script>
<script src="assets/js/chart-functions.js"></script>
<script src="assets/js/graph-scroll.js"></script>

<script>

    // D3 MAP SCALE
    var scaleSVG = d3.select("#legend").append("svg").attr("height", 120);

    var scale = scaleSVG.append("g")
            .attr("class", "scale")
            .attr("class", "key")
            .attr("transform", "translate(25,0)");

    scaleSVG.append("g").attr("class","grayRect").append("rect")
            .attr("height", 15)
            .attr("width", 50)
            .style("fill", "gray")
            .attr("data-metric", "gray")
            .style("stroke", "black")
            .style("stroke-width", 2)
            .attr("transform", "translate(130,60)");
    scaleSVG.append("text")
            .text("Missing Data*")
            .style("font-size", 12)
            .attr("transform", "translate(120,90)");

    var formatNumber = d3.format(",d");

    var color = d3.scale.threshold()
            .domain([0, 3, 6, 12])
            .range(["#f2f0f7", "#cbc9e2", "#9e9ac8", "#756bb1", "#54278f"]);
    var xKey = d3.scale.linear()
            .domain([-3, 15])
            .range([0, 250]);

    var xAxis = d3.svg.axis()
            .scale(xKey)
            .orient("bottom")
            .tickSize(25)
            .tickValues(color.domain())
            .tickFormat(function (d) {
                return d >= 0 ? formatNumber(d) : null;
            });
    var key = d3.select(".key");

    scale.selectAll("rect")
            .data(color.range().map(function (d, i) {
                return {
                    x0: i ? xKey(color.domain()[i - 1]) : xKey.range()[0],
                    x1: i < color.domain().length ? xKey(color.domain()[i]) : xKey.range()[1],
                    z: d
                };
            })).enter().append("g")
            .append("rect")
            .attr("height", 15)
            .attr("x", function (d) {
                return d.x0;
            })
            .attr("width", function (d) {
                return d.x1 - d.x0;
            })
            .attr("data-metric", function (d) {
                return d.z;
            })
            .style("fill", function (d) {
                return d.z;
            })
            .style("stroke", "black")
            .style("stroke-width", 2)
            .style("margin", 1);

    scale.call(xAxis).append("text")
            .attr("class", "caption")
            .attr("y", -6)
            .text("Absent per District");

    scaleSVG.selectAll("rect")
            .on("mouseover", function () {
                var item = d3.select(this);
                if (!key.classed("scaleSelect")) {
                    var itemColor = item.attr("data-metric");
                    svg.selectAll(".district")
                            .attr("fill", function (d) {
                                if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                                    return itemColor;
                                } else {
                                    return "lightgray";
                                }
                            });

                    svg.selectAll(".secondaryDistrict")
                            .attr("fill", function (d) {
                                if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                                    return itemColor;
                                } else {
                                    return "lightgray";
                                }
                            });
                }
            }).on("mouseout", function () {
        if (!key.classed("scaleSelect")) {
            updateColors();
        }
    }).on("click", function () {
        var item = d3.select(this);
        var itemColor = item.attr("data-metric");
        if (key.classed("scaleSelect") && item.classed("scaleSelect")) {
            key.attr("class", "key");
            item.attr("class", "");
            item.style("stroke", "black");
            updateColors();
        } else if (key.classed("scaleSelect") && !item.classed("scaleSelect")) {
            d3.select("rect.scaleSelect").attr("class", "").style("stroke", "black");
            item.style("stroke", "yellow");
            item.attr("class", "scaleSelect");
            svg.selectAll(".district")
                    .attr("fill", function (d) {
                        if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                            return itemColor;
                        } else {
                            return "lightgray";
                        }
                    });

            svg.selectAll(".secondaryDistrict")
                    .attr("fill", function (d) {
                        if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                            return itemColor;
                        } else {
                            return "lightgray";
                        }
                    });
        } else {
            item.attr("class", "scaleSelect");
            item.style("stroke", "yellow");
            key.attr("class", "key scaleSelect");
            svg.selectAll(".district")
                    .attr("fill", function (d) {
                        if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                            return itemColor;
                        } else {
                            return "lightgray";
                        }
                    });

            svg.selectAll(".secondaryDistrict")
                    .attr("fill", function (d) {
                        if (itemColor == colorByGroup(d.properties["Percent OOS"])) {
                            return itemColor;
                        } else {
                            return "lightgray";
                        }
                    });
        }
    });

    //  D3 MAP
    var width = 960;
    var height = 600;
    var center = [width / 2, height / 2];
    var defaultFill = "lightgray";

    var projection = d3.geo.albersUsa();

    var path = d3.geo.path()
            .projection(projection);

    var zoom = d3.behavior.zoom()
            .scaleExtent([1, 8])
            .on("zoom", move);

    var svg = d3.select("#map").append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 " + width + " " + height)
            .classed("svg-content-responsive", true)
            .append("g")
            .call(zoom);
    svg.on("wheel.zoom", null);
    svg.on("mousewheel.zoom", null);

    svg.append("svg:image")
            .attr("xlink:href", "images/progress-anim.gif")
            .attr("id", "progress-image")
            .attr("width", 43)
            .attr("height", 11)
            .attr("x", width / 2)
            .attr("y", height / 2)
            .style("opacity", 1);

    var g = svg.append("g");

    var tooltip = d3.select("body").append("div")
            .attr("class", "districtTooltip")
            .style("opacity", 0);

    queue()
            .defer(d3.json, "assets/data/us.json")
            .defer(d3.json, "assets/data/elementary_unified.json")
            .defer(d3.json, "assets/data/secondary.json")
            .await(ready);

    function ready(error, us, primary, secondary) {
        if (error) {
            console.log(error);
        }
        g.append("g")
                .selectAll("path")
                .data(topojson.feature(primary, primary.objects.medium_G5420_G5400).features)
                .enter().append("path")
                .attr("class", "district")
                .attr("d", path)
                .attr("stroke", "#fff")
                .attr("stroke-opacity", .15)
                .attr("stroke-linejoin", "round")
                .on("mouseover", function (d) {
                    d3.select(this).attr("stroke", "#1A1C20")
                            .attr("stroke-opacity", 1)
                            .attr("stroke-width", .5);
                    d3.select(this).classed("selected", true);

                    tooltip.transition().duration(100).style("opacity", 1);

                    var windowWidth = $(window).width();
                    if (windowWidth > 1024) {
                        if (d3.event.pageX > 1000) {
                            tooltip.style("left", (d3.event.pageX - 200) + "px")
                                    .style("top", (d3.event.pageY - 150) + "px");
                        } else {
                            tooltip.style("left", (d3.event.pageX + 40) + "px")
                                    .style("top", (d3.event.pageY - 150) + "px");
                        }
                    }
                    if (windowWidth < 1024) {
                        if (d3.event.pageX > 400) {
                            tooltip.style("left", (d3.event.pageX - 200) + "px")
                                    .style("top", (d3.event.pageY - 150) + "px");
                        } else {
                            tooltip.style("left", (d3.event.pageX + 40) + "px")
                                    .style("top", (d3.event.pageY - 150) + "px");
                        }
                    }
                    if (d.properties["Percent OOS"] != null) {
                        tooltip.html("<h3>" + d.properties.State + "</h3><hr>" +
                                "<h3>" + d.properties.Name + "</h3>" +
                                "<div>Total OOS: " + d.properties['Total OOS'] + "</div>" +
                                "<div>Percent OOS: " + d.properties['Percent OOS'] + "</div>");

                    } else {
                        tooltip.html("<h3>" + d.properties.State + "</h3><hr>" +
                                "<h3>" + d.properties.Name + "</h3>" +
                                "<div>Total OOS: NO DATA</div>" +
                                "<div>Percent OOS: NO DATA </div>");
                    }
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke", "#fff")
                            .attr("stroke-opacity", .15)
                            .attr("stroke-width", .2);
                    d3.select(this).classed("selected", false);
                    tooltip.transition().duration(300).style("opacity", 0);
                });

        g.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("class", "state")
                .attr("d", path);

        d3.select("#selectElementary").on("click", function () {
            d3.select("rect.scaleSelect").attr("class", "").style("stroke", "black");
            key.attr("class", "key");
            d3.select("#selectSecondary").style("background", "white");
            d3.select(this).style("background", "yellow");
            d3.selectAll("#secondaryDistrict").remove();
        });

        d3.select("#selectSecondary").on("click", function () {
            d3.select("rect.scaleSelect").attr("class", "").style("stroke", "black");
            key.attr("class", "key");
            d3.selectAll(".state").remove();
            d3.select("#selectElementary").style("background", "white");
            d3.select(this).style("background", "yellow");
            g.append("g")
                    .selectAll("path")
                    .data(topojson.feature(secondary, secondary.objects.medium_G5410).features)
                    .enter().append("path")
                    .attr("id","secondaryDistrict")
                    .attr("class", "district")
                    .attr("d", path)
                    .attr("stroke", "#fff")
                    .attr("stroke-opacity", .15)
                    .attr("stroke-linejoin", "round")
                    .on("mouseover", function (d) {
                        d3.select(this).attr("stroke", "#1A1C20")
                                .attr("stroke-opacity", 1)
                                .attr("stroke-width", .5);
                        d3.select(this).classed("selected", true);

                        tooltip.transition().duration(100).style("opacity", 1);

                        var windowWidth = $(window).width();
                        if (windowWidth > 1024) {
                            if (d3.event.pageX > 1000) {
                                tooltip.style("left", (d3.event.pageX - 200) + "px")
                                        .style("top", (d3.event.pageY - 150) + "px");
                            } else {
                                tooltip.style("left", (d3.event.pageX + 40) + "px")
                                        .style("top", (d3.event.pageY - 150) + "px");
                            }
                        }
                        if (windowWidth < 1024) {
                            if (d3.event.pageX > 400) {
                                tooltip.style("left", (d3.event.pageX - 200) + "px")
                                        .style("top", (d3.event.pageY - 150) + "px");
                            } else {
                                tooltip.style("left", (d3.event.pageX + 40) + "px")
                                        .style("top", (d3.event.pageY - 150) + "px");
                            }
                        }
                        if (d.properties["Percent OOS"] != null) {
                            tooltip.html("<h3>" + d.properties.State + "</h3><hr>" +
                                    "<h3>" + d.properties.Name + "</h3>" +
                                    "<div>Total OOS: " + d.properties['Total OOS'] + "</div>" +
                                    "<div>Percent OOS: " + d.properties['Percent OOS'] + "</div>");

                        } else {
                            tooltip.html("<h3>" + d.properties.State + "</h3><hr>" +
                                    "<h3>" + d.properties.Name + "</h3>" +
                                    "<div>Total OOS: NO DATA</div>" +
                                    "<div>Percent OOS: NO DATA </div>");
                        }
                    })
                    .on("mouseout", function () {
                        d3.select(this).attr("stroke", "#fff")
                                .attr("stroke-opacity", .15)
                                .attr("stroke-width", .2);
                        d3.select(this).classed("selected", false);
                        tooltip.transition().duration(300).style("opacity", 0);
                    });
            updateColors();
            g.append("g")
                    .attr("class", "states")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter().append("path")
                    .attr("class", "state")
                    .attr("d", path);
        });

        // Zoom buttons
        svg.selectAll(".button")
                .data(['zoom_in', 'zoom_out'])
                .enter()
                .append("g")
                .attr("id", function (d) {
                    return d
                })
                .attr("class", "button")
                .attr({x: 20, width: 20, height: 20})
                .append("rect")
                .attr("y", function (d, i) {
                    return 20 + 25 * i
                })
                .attr({x: 20, width: 20, height: 20});

        // Plus button
        svg.select("#zoom_in")
                .append("line")
                .attr({x1: 25, y1: 30, x2: 35, y2: 30})
                .attr("stroke", "#fff")
                .attr("stroke-width", "2px");
        svg.select("#zoom_in")
                .append("line")
                .attr({x1: 30, y1: 25, x2: 30, y2: 35})
                .attr("stroke", "#fff")
                .attr("stroke-width", "2px");

        // Minus button
        svg.select("#zoom_out")
                .append("line")
                .attr({x1: 25, y1: 55, x2: 35, y2: 55})
                .attr("stroke", "#fff")
                .attr("stroke-width", "2px");

        svg.selectAll(".button")
                .on("click", function () {
                    d3.event.preventDefault();

                    var scale = zoom.scale(),
                            extent = zoom.scaleExtent(),
                            translate = zoom.translate(),
                            x = translate[0], y = translate[1],
                            factor = (this.id === 'zoom_in') ? 2 : 1 / 2,
                            target_scale = scale * factor;

                    var clamped_target_scale = Math.max(extent[0], Math.min(extent[1], target_scale));
                    if (clamped_target_scale != target_scale) {
                        target_scale = clamped_target_scale;
                        factor = target_scale / scale;
                    }

                    // Center each vector, stretch, then put back
                    x = (x - center[0]) * factor + center[0];
                    y = (y - center[1]) * factor + center[1];

                    // Transition to the new view over 350ms
                    d3.transition().duration(350).tween("zoom", function () {
                        var interpolate_scale = d3.interpolate(scale, target_scale),
                                interpolate_trans = d3.interpolate(translate, [x, y]);
                        return function (t) {
                            zoom.scale(interpolate_scale(t))
                                    .translate(interpolate_trans(t));
                            svg.call(zoom.event);
                        };
                    });
                });
        updateColors();
        svg.select("#progress-image").style("opacity", 0);
    }

    function updateColors() {
        svg.selectAll(".district")
                .attr("fill", function (d) {
                    return colorByGroup(d.properties["Percent OOS"]);
                });
        svg.selectAll(".secondaryDistrict")
                .attr("fill", function (d) {
                    return colorByGroup(d.properties["Percent OOS"]);
                });
    }

    function colorByGroup(p) {

        var d = isNaN(parseFloat(p)) ? -1 : parseFloat(p);
        return d == 0 ? '#f2f0f7' :
                (d > 0 && d <= 3) ? '#cbc9e2' :
                        (d > 3 && d <= 6) ? '#9e9ac8' :
                                (d > 6 && d <= 12) ? '#756bb1' :
                                        (d > 12) ? '#54278f' :
                                                (d < 0) ? 'gray' :
                                                        defaultFill;
    }

    function zoomIn() {
        zoom.scale(zoom.scale() * 2);
        move();
    }

    function move() {
        var t = d3.event.translate,
                s = d3.event.scale;
        t[0] = Math.min(width * (s - 1), Math.max(width * (1 - s), t[0]));
        t[1] = Math.min(height * (s - 1), Math.max(height * (1 - s), t[1]));
        zoom.translate(t);
        g.style("stroke-width", 1 / s).attr("transform", "translate(" + t + ")scale(" + s + ")");
    }

    function clicked(d) {
        var x, y, k;
        var centered;
        if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 4;
            centered = d;
        } else {
            x = width / 2;
            y = height / 2;
            k = 1;
            centered = null;
        }

        g.selectAll("path")
                .classed("active", centered && function (d) {
                            return d === centered;
                        });

        g.transition()
                .duration(750)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
    }

    function removeFromArray(arr) {
        var what, a = arguments, L = a.length, ax;
        while (L > 1 && arr.length) {
            what = a[--L];
            while ((ax = arr.indexOf(what)) !== -1) {
                arr.splice(ax, 1);
            }
        }
        return arr;
    }
    d3.select(self.frameElement).style("height", height + "px");
</script>
</body>
</html>
